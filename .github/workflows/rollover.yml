# .github/workflows/rollover.yml
name: Rollover (Rolling Deletion)

on:
  schedule:
    - cron: "25 7 * * *"
  workflow_dispatch: {}

concurrency:
  group: rollover
  cancel-in-progress: false

jobs:
  rollover:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyyaml

      - name: Load ops config and run rollover
        env:
          # Single secret reference (edit only ops_config.yml if secret name changes)
          GH_DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python - <<'PY'
          import os, yaml, subprocess, sys
          cfg = yaml.safe_load(open("ops_config.yml","r",encoding="utf-8"))
          env_var = cfg["database"]["env_var"]
          db_url = os.environ.get("GH_DB_URL","").strip()
          if not db_url:
              raise SystemExit("Missing GitHub secret DATABASE_URL (or ops_config.yml github_secret mismatch).")
          os.environ[env_var] = db_url
          config_path = cfg["rollover"]["config_path"]
          subprocess.check_call([sys.executable, "rollover.py", "--config", config_path])
          PY
